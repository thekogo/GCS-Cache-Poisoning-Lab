proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off;

server {
    listen 80;

    location / {
        # Resolver is required when using domain names in proxy_pass in some setups, 
        # but here we hardcode the upstream. 
        # We use Google DNS just in case we need to resolve storage.googleapis.com dynamically.
        resolver 8.8.8.8;

        # --- THE VULNERABILITY ---
        # The cache key only relies on the URL, ignoring the X-HTTP-Method-Override header.
        proxy_cache my_cache;
        proxy_cache_valid 200 60m; # Cache successful responses for 1 hour
        # Default key typically excludes headers, but defining it explicitly makes it clear.
        proxy_cache_key $scheme$proxy_host$request_uri;

        # --- GCS PROXY CONFIG ---
        proxy_set_header Host storage.googleapis.com;
        proxy_set_header Connection "";
        proxy_http_version 1.1;
        proxy_ssl_server_name on; # Required for SNI with GCS

        # Replace 'REPLACE_WITH_YOUR_BUCKET_NAME' with your actual bucket name
        # We rewrite the path so /index.html becomes /bucket-name/index.html
        rewrite ^/(.*)$ /REPLACE_WITH_YOUR_BUCKET_NAME/$1 break;
        
        proxy_pass https://storage.googleapis.com;
        
        # Add a header to debug cache status
        add_header X-Cache-Status $upstream_cache_status;
    }
}
